{% extends "form.html" %}
{% from "StatisticsMacro.html" import stats_cards, frequent_sender_cards %}
{% block content %}{% if session.name %}
     
<div class="page-container">
        <!-- Page Title -->
       <h1 class="page-title">Statistics</h1>
        <!-- Two Column Layout -->
        <div class="statistics-layout">
            <!-- Left Column: Topics List -->
            <div class="statistics-sidebar">
                <div class="content-section">
                    <h3 class="section-header">Sort By</h3>
                    <!-- Admin Dashboard Button -->
                    
                     {% if session.name == 'admin' %}
                        <button class="sort-btn" data-target="admin">
                            <div class="btn-content">
                                <div class="btn-header">
                                    <i class="bi bi-shield-lock-fill"></i>
                                    <span>Admin Dashboard</span>
                                </div>
                                <span class="button-description">Access administrative controls and system management</span>
                            </div>
                        </button>
                        {% endif %}

                    <div class="sort-buttons">
                        <button class="sort-btn active" data-target="general">
                            <div class="btn-content">
                                <div class="btn-header">
                                    <i class="bi bi-bar-chart-fill"></i> 
                                    <span>General</span>
                                </div>
                                <span class="button-description">View general statistics about the application</span>
                            </div>
                        </button>

                        <button class="sort-btn" data-target="senders">
                            <div class="btn-content">
                                <div class="btn-header">
                                    <i class="bi bi-hdd-network-fill"></i>
                                    <span>Frequent Sender</span>
                                    {% if frequent_senders.dangerous_ips > 0 %}
                                    <span class="badge badge-danger">{{ frequent_senders.dangerous_ips }}</span>
                                    {% endif %}
                                </div>
                                <span class="button-description">View IP addresses that send the most emails - identify potential threats</span>
                            </div>
                        </button>

                        <button class="sort-btn" data-target="subjects">
                            <div class="btn-content">
                                <div class="btn-header">
                                    <i class="bi bi-envelope"></i>
                                    <span>Common Subject</span>
                                </div>
                                <span class="button-description">Order the subjects by how commonly they are found in phishing emails</span>
                            </div>
                        </button>
                        <button class="sort-btn" data-target="comments">
                            <div class="btn-content">
                                <div class="btn-header">
                                    <i class="bi bi-chat-left-text"></i>
                                    <span>Most Commented</span>
                                </div>
                                <span class="button-description">Search for forum post that have the most amount of comments</span>
                            </div>
                        </button>
                        
                       
                    </div>
                </div>
            </div>

            <!-- Vertical Divider Line -->
            <div class="column-divider"></div>

            <!-- Right Column: Two Column Layout -->
            <div class="dashboard-main">
                <div class="content-section uploads-container">
                    <div class="panel-title-container">
                        <h3 class="panel-title" id="panel-title">General</h3>
                    </div>
                    
                    <!-- General Statistics Panel (default/first shown) -->
                    <div class="stats-panel active" data-panel="general">
                        {{ stats_cards(stats) }}
                    </div>

                    <!-- Frequent Sender Panel -->
                    <div class="stats-panel" data-panel="senders">
                        {{ frequent_sender_cards(frequent_senders) }}
                    </div>

                    <!-- Admin Dashboard Panel -->
                    {% if session.name == 'admin' %}
                    <div class="stats-panel" data-panel="admin">
                        <div class="content-section">
                            <h4 class="section-header"><i class="bi bi-gear-fill"></i> Admin Overview & Controls</h4>
                            <div class="stats-grid">
                                <!-- User Statistics -->
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                                    <div class="stat-value">{{ stats.total_users or 0 }}</div>
                                    <div class="stat-label">Total Users</div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-person-check-fill"></i></div>
                                    <div class="stat-value">{{ stats.active_sessions or 0 }}</div>
                                    <div class="stat-label">Active Sessions</div>
                                </div>
                                
                                <!-- Upload Statistics -->
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-upload"></i></div>
                                    <div class="stat-value">{{ stats.total_uploads or 0 }}</div>
                                    <div class="stat-label">Total Uploads</div>
                                </div>
                                
                                <div class="stat-card stat-phishing">
                                    <div class="stat-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                    <div class="stat-value">{{ stats.phishing_detected or 0 }}</div>
                                    <div class="stat-label">Phishing Detected</div>
                                </div>
                                
                                <!-- Forum Statistics -->
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-chat-dots-fill"></i></div>
                                    <div class="stat-value">{{ stats.total_posts or 0 }}</div>
                                    <div class="stat-label">Forum Posts</div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-chat-left-text-fill"></i></div>
                                    <div class="stat-value">{{ stats.total_comments or 0 }}</div>
                                    <div class="stat-label">Total Comments</div>
                                </div>
                                
                                <!-- Moderation Statistics -->
                                <div class="stat-card stat-suspicious">
                                    <div class="stat-icon"><i class="bi bi-flag-fill"></i></div>
                                    <div class="stat-value">{{ stats.pending_moderations or 0 }}</div>
                                    <div class="stat-label">Pending Moderations</div>
                                </div>
                                
                                <div class="stat-card stat-phishing">
                                    <div class="stat-icon"><i class="bi bi-shield-exclamation"></i></div>
                                    <div class="stat-value">{{ stats.flagged_ips or 0 }}</div>
                                    <div class="stat-label">Flagged IPs</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section" style="margin-top: 1.5rem;">
                            <h4 class="section-header"><i class="bi bi-activity"></i> System Status</h4>
                            <div class="stats-grid">
                                <div class="stat-card {% if stats.server_status == 'Online' %}stat-benign{% elif stats.server_status == 'Error' %}stat-phishing{% else %}stat-suspicious{% endif %}">
                                    <div class="stat-icon"><i class="bi bi-server"></i></div>
                                    <div class="stat-value" style="font-size: 1.2rem;">{{ stats.server_status or 'Unknown' }}</div>
                                    <div class="stat-label">Server Status</div>
                                </div>
                                
                                <div class="stat-card {% if stats.database_status == 'Connected' %}stat-benign{% elif stats.database_status == 'Error' %}stat-phishing{% else %}stat-suspicious{% endif %}">
                                    <div class="stat-icon"><i class="bi bi-database-fill"></i></div>
                                    <div class="stat-value" style="font-size: 1.2rem;">{{ stats.database_status or 'Unknown' }}</div>
                                    <div class="stat-label">Database Status</div>
                                </div>
                                
                                <div class="stat-card {% if stats.api_services_status == 'Active' %}stat-benign{% elif stats.api_services_status == 'Error' %}stat-phishing{% else %}stat-suspicious{% endif %}">
                                    <div class="stat-icon"><i class="bi bi-cloud-check-fill"></i></div>
                                    <div class="stat-value" style="font-size: 1.2rem;">{{ stats.api_services_status or 'Unknown' }}</div>
                                    <div class="stat-label">API Services</div>
                                </div>
                                
                                <div class="stat-card {% if stats.virustotal_status == 'Connected' %}stat-benign{% elif stats.virustotal_status in ['Error', 'Disconnected'] %}stat-phishing{% else %}stat-suspicious{% endif %}">
                                    <div class="stat-icon"><i class="bi bi-shield-check"></i></div>
                                    <div class="stat-value" style="font-size: 1rem;">{{ stats.virustotal_status or 'Unknown' }}</div>
                                    <div class="stat-label">VirusTotal API</div>
                                </div>
                                
                                <div class="stat-card {% if stats.abuseipdb_status == 'Connected' %}stat-benign{% elif stats.abuseipdb_status in ['Error', 'Disconnected'] %}stat-phishing{% else %}stat-suspicious{% endif %}">
                                    <div class="stat-icon"><i class="bi bi-shield-fill-check"></i></div>
                                    <div class="stat-value" style="font-size: 1rem;">{{ stats.abuseipdb_status or 'Unknown' }}</div>
                                    <div class="stat-label">AbuseIPDB API</div>
                                </div>
                                
                                <div class="stat-card {% if stats.llm_status == 'Running' %}stat-benign{% elif stats.llm_status in ['Error', 'Disconnected'] %}stat-phishing{% else %}stat-suspicious{% endif %}">
                                    <div class="stat-icon"><i class="bi bi-cpu-fill"></i></div>
                                    <div class="stat-value" style="font-size: 1rem;">{{ stats.llm_status or 'Unknown' }}</div>
                                    <div class="stat-label">LLM Service</div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-hdd-fill"></i></div>
                                    <div class="stat-value">{{ stats.storage_available or 'N/A' }}</div>
                                    <div class="stat-label">Storage Used</div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                                    <div class="stat-value" style="font-size: 0.9rem;">{{ stats.last_backup or 'Never' }}</div>
                                    <div class="stat-label">Last Activity</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Frequent Receiver Panel -->
                    <div class="stats-panel" data-panel="receivers">
                        <div class="stats-panel-two-col">
                            <!-- Top Column -->
                            <div class="stats-column">
                                <div class="content-section">
                                    <h4 class="section-header"><i class="bi bi-fire"></i> Top</h4>
                                    <div class="small-data-list">
                                        <div class="small-data-item"><span class="small-label">user 1 </span><span class="small-value">11</span></div>
                                        <div class="small-data-item"><span class="small-label">user 2</span><span class="small-value">10</span></div>
                                   
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Historical Uploaded Column -->
                            <div class="stats-column">
                                <div class="content-section">
                                    <h4 class="section-header"><i class="bi bi-clock-history"></i> Historical</h4>
                                    <div class="small-data-list">
                                        <div class="small-data-item"><span class="small-label">Test</span><span class="small-value">156</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Common Subject Panel -->
                    <div class="stats-panel" data-panel="subjects">
                        <div class="stats-panel-two-col">
                            <!-- Top Column -->
                            <div class="stats-column">
                                <div class="content-section">
                                    <h4 class="section-header"><i class="bi bi-fire"></i> Top</h4>
                                    <div class="small-data-list">
                                        <div class="small-data-item"><span class="small-label">"Action Required"</span><span class="small-value">54</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Historical Uploaded Column -->
                            <div class="stats-column">
                                <div class="content-section">
                                    <h4 class="section-header"><i class="bi bi-clock-history"></i> Historical</h4>
                                    <div class="small-data-list">
                                        <div class="small-data-item"><span class="small-label">"Update Payment"</span><span class="small-value">47</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Most Commented Panel -->
                    <div class="stats-panel" data-panel="comments">
                        <div class="stats-panel-two-col">
                            <!-- Top Column -->
                            <div class="stats-column">
                                <div class="content-section">
                                    <h4 class="section-header"><i class="bi bi-fire"></i> Top</h4>
                                    <div class="small-data-list">
                                        <div class="small-data-item"><span class="small-label">Vendor invoice fraud</span><span class="small-value">18</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Historical Uploaded Column -->
                            <div class="stats-column">
                                <div class="content-section">
                                    <h4 class="section-header"><i class="bi bi-clock-history"></i> Historical</h4>
                                    <div class="small-data-list">
                                        <div class="small-data-item"><span class="small-label">Social engineering techniques</span><span class="small-value">31</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
   </div>

    <script>
        (function() {
            const buttons = document.querySelectorAll('.sort-btn');
            const panels = document.querySelectorAll('.stats-panel');
            const panelTitle = document.getElementById('panel-title');
            
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-target');
                    const btnText = btn.querySelector('.btn-header span:nth-of-type(1)').textContent.trim();
                    
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    panels.forEach(p => p.classList.toggle('active', p.getAttribute('data-panel') === target));
                    
                    // Update the panel title
                    if (panelTitle) {
                        panelTitle.textContent = btnText;
                    }
                });
            });
        })();
    </script>

{% else %}
<div class="page-container">
    <h1 class="page-title">Statistics Overview</h1>
    
    <div class="content-section">
        <h3 class="section-header"></i> General Statistics</h3>
        {{ stats_cards(stats) }}
    </div>
    
    <div class="content-section" style="margin-top: 2rem; text-align: center;">
        <p><strong>Want to see more?</strong> Create an account to access more metrics and contribute to our community.</p>
        <button type="button" class="btn-signup" onclick="document.getElementById('LoginContainer').style.display = 'block';"><i class="bi bi-person-plus"></i> Sign Up Now</button>
    </div>
</div>
{% endif %}{% endblock %}
